name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - "**/*.html"
      - "pages.json"
      - ".github/workflows/deploy.yml"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if should deploy
        id: check
        run: |
          # 获取修改的文件
          MODIFIED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

          # 检查是否修改了配置文件
          if echo "$MODIFIED_FILES" | grep -qE '(pages\.json|\.github/workflows/deploy\.yml)'; then
            echo "配置文件已修改，触发部署"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 检查修改的 HTML 文件是否在 pages.json 中
          HTML_FILES=$(echo "$MODIFIED_FILES" | grep '\.html$' || true)

          if [ -z "$HTML_FILES" ]; then
            echo "无相关文件修改"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PAGES_JSON=$(cat pages.json)
          SHOULD_DEPLOY=false

          for file in $HTML_FILES; do
            if echo "$PAGES_JSON" | grep -q "\"\./$file\""; then
              echo "$file 在 pages.json 中，触发部署"
              SHOULD_DEPLOY=true
              break
            fi
          done

          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Pages
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/configure-pages@v4

      - name: Build site
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          mkdir -p _site

          # 根据 pages.json 构建站点
          node -e "
          const fs = require('fs');
          const path = require('path');
          const pages = JSON.parse(fs.readFileSync('pages.json', 'utf8'));

          // 复制 HTML 文件到对应路由
          pages.forEach(item => {
            const htmlPath = item.html.replace('./', '');
            const pagePath = item.page;
            
            const targetDir = path.join('_site', pagePath);
            fs.mkdirSync(targetDir, { recursive: true });
            
            const targetFile = path.join(targetDir, 'index.html');
            fs.copyFileSync(htmlPath, targetFile);
            
            console.log(\`Copied \${htmlPath} to \${targetFile}\`);
          });

          // 生成索引页
          const indexHtml = \`<!DOCTYPE html>
          <html lang=\"zh-CN\">
          <head>
            <meta charset=\"UTF-8\">
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
            <title>Info Vis - Index</title>
            <style>
              body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0366d6; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>Info Vis Pages</h1>
            <ul>
              \${pages.map(p => \`<li><a href=\"\${p.page}\">\${p.page}</a></li>\`).join('')}
            </ul>
          </body>
          </html>\`;

          fs.writeFileSync('_site/index.html', indexHtml);
          console.log('Created index page');
          "

      - name: Upload artifact
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        if: steps.check.outputs.should_deploy == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
